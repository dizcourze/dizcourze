function setCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  let expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(";");
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == " ") {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
function run() {
  chkLangandGo();
  chkTheme();
}
function chkTheme() {
  if (getCookie("theme") == "0") {
    setCookie("theme", "0", 365);
	document.getElementsByTagName("link")[1].href = "https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-dark.min.css";
	document.getElementsByTagName("link")[2].href = "/asset/style-dark.min.css";
  } else {
    setCookie("theme", "1", 365);
  }
}
function chkLangandGo() {
  if (getCookie("lang") == "") {
    fetch("https://www.cloudflare.com/cdn-cgi/trace").then(x => x.text()).then(y => go(y));
  } else if (getCookie("lang") == "TW") {
    y = "TW";
	go(y);
  } else if (getCookie("lang") == "JP") {
    y = "JP";
	go(y);
  } else {
    y = "EN";
	go(y);
  }
}
function go(y) {
  if (y.indexOf("TW") != -1) {
    setCookie("lang", "TW", 365);
	lang = {"srh":"搜尋","err":"糟糕，出錯啦！請重新載入頁面再試一次。","about":"簡介","theme":"外觀","lang":"語言","donate":"捐贈","github":"GitHub","email":"電子郵件地址","light":"淺色","dark":"深色","en":"English","tw":"繁體中文","jp":"日本語","address":"以太坊地址","acc":"已將地址複製到剪貼簿","year":"年","mon":"月","date":"日","s":"秒","m":"分","h":"小時","flag":"成功檢舉","lcc":"已將連結複製到剪貼簿","w":"萬","ava":"大頭貼連結","name":"使用者名稱","sap":"傳送貼文","sam":"傳送訊息"};
	chkPath();
  } else if (y.indexOf("JP") != -1) {
    setCookie("lang", "JP", 365);
	lang = {"srh":"検索","err":"エラーが発生しました。ページを更新して再度お試しください。","about":"概要","theme":"デザイン","lang":"言語","donate":"寄付","github":"GitHub","email":"メールアドレス","light":"ライト","dark":"ダーク","en":"English","tw":"繁體中文","jp":"日本語","address":"イーサリアムアドレス","acc":"アドレスをクリップボードにコピーしました","year":"年","mon":"月","date":"日","s":"秒","m":"分","h":"時間","flag":"正常に報告されました","lcc":"リンクをクリップボードにコピーしました","w":"万","ava":"プロフィール画像リンク","name":"ユーザー名","sap":"ポストを送信","sam":"メッセージを送信"};
	chkPath();
  } else {
    setCookie("lang", "EN", 365);
	lang = {"srh":"Search","err":"Oops! Something went wrong. Please reload the page and try again.","about":"About","theme":"Appearance","lang":"Language","donate":"Donate","github":"GitHub","email":"Email Address","light":"Light","dark":"Dark","en":"English","tw":"繁體中文","jp":"日本語","address":"Ethereum Address","acc":"Address copied to clipboard","s":"s","m":"m","h":"h","flag":"Successfully flagged","lcc":"Link copied to clipboard","k":"K","ava":"Profile picture link","name":"Username","sap":"Send a post","sam":"Send a message"};
	chkPath();
  }
}
function chkPath() {
  if (location.href.split("/")[3] == "" && location.href.split("/")[4] == undefined) {
    indexPage();
  } else if (location.href.split("/")[3] == "more" && location.href.split("/")[4] == undefined) {
    morePage();
  } else if (location.href.split("/")[3].startsWith("search?q=") && location.href.split("/")[4] == undefined) {
    searchPage();
  } else if (location.href.split("/")[3] == "post" && location.href.split("/")[4] != undefined) {
    postPage();
  } else {
    errPage();
  }
}
function errPage() {
  document.getElementsByTagName("title")[0].innerHTML = "Error - Dizcourze";
  document.getElementById("main").innerHTML = "<div id='app'><header><a class='s-btn' href='/' target='_blank'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='s-btn' onclick='srh()'><span class='icon-search'></span></a><a class='s-btn' href='/more' target='_blank'><span class='icon-more'></span></a></header><div id='content'><div class='err'>"+lang["err"]+"</div></div><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div>";
  document.getElementById("content").addEventListener("scroll", chkTop);
  document.getElementById("srh").addEventListener("keypress", chkSrh);
}
function searchPage() {
  document.getElementsByTagName("title")[0].innerHTML = "#"+decodeURI(location.href.split("/")[3].substring(9))+" - Dizcourze";
  document.getElementById("main").innerHTML = "<div id='app'><header><a class='s-btn' href='/' target='_blank'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='s-btn' onclick='srh()'><span class='icon-search'></span></a><a class='s-btn' href='/more' target='_blank'><span class='icon-more'></span></a></header><div id='content'><div id='load'><a class='spinner'></a></div></div><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'></div>";
  document.getElementById("content").addEventListener("scroll", chkTopandSearch);
  document.getElementById("srh").addEventListener("keypress", chkSrh);
  db.collection("post").where("tag", "array-contains", decodeURI(location.href.split("/")[3].substring(9))).orderBy("created", "desc").startAfter(new Date()).limit(10).onSnapshot((snapshot) => {
	snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		document.getElementById("content").append(tmp);
		if (document.getElementById("load") != null) {
		  document.getElementById("load").remove();
		}
		cursor = change.doc.data()["created"].toDate();
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
	if (document.getElementById("load") != null) {
	  document.getElementById("load").remove();
	}
  });
  db.collection("post").where("tag", "array-contains", decodeURI(location.href.split("/")[3].substring(9))).orderBy("created").startAfter(new Date()).onSnapshot((snapshot) => {
	snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+new Date()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		document.getElementById("content").prepend(tmp);
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
}
function indexPage() {
  document.getElementById("main").innerHTML = "<div id='app'><header><a class='s-btn' href='/' target='_blank'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='s-btn' onclick='srh()'><span class='icon-search'></span></a><a class='s-btn' href='/more' target='_blank'><span class='icon-more'></span></a></header><div id='content'><div id='load'><a class='spinner'></a></div></div><header class='bot'><input id='ava' type='text' autocomplete='off' placeholder='"+lang["ava"]+"' maxlength='40'><input id='name' type='text' autocomplete='off' placeholder='"+lang["name"]+"' maxlength='20'><input id='text' type='text' autocomplete='off' placeholder='"+lang["sap"]+"' maxlength='80'><a class='s-btn' onclick='sendPost()'><span class='icon-send'></span></a></header><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'></div>";
  document.getElementById("content").style.height = "calc(100% - 10rem)";
  document.getElementById("top").style.bottom = "6.3125rem";
  document.getElementById("content").addEventListener("scroll", chkTopandIndex);
  document.getElementById("srh").addEventListener("keypress", chkSrh);
  document.getElementById("text").addEventListener("keypress", chkSap);
  db.collection("post").orderBy("created", "desc").startAfter(new Date()).limit(10).onSnapshot((snapshot) => {
	snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		document.getElementById("content").append(tmp);
		if (document.getElementById("load") != null) {
		  document.getElementById("load").remove();
		}
		cursor = change.doc.data()["created"].toDate();
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
	if (document.getElementById("load") != null) {
	  document.getElementById("load").remove();
	}
  });
  db.collection("post").orderBy("created").startAfter(new Date()).onSnapshot((snapshot) => {
	snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+new Date()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		document.getElementById("content").prepend(tmp);
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
}
function postPage() {
  document.getElementsByTagName("title")[0].innerHTML = "Post - Dizcourze";
  document.getElementById("main").innerHTML = "<div id='app'><header><a class='s-btn' href='/' target='_blank'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='s-btn' onclick='srh()'><span class='icon-search'></span></a><a class='s-btn' href='/more' target='_blank'><span class='icon-more'></span></a></header><div id='content'><div id='major'><div id='load'><a class='spinner'></a></div></div><div id='minor'></div></div><header class='bot'><input id='ava' type='text' autocomplete='off' placeholder='"+lang["ava"]+"' maxlength='40'><input id='name' type='text' autocomplete='off' placeholder='"+lang["name"]+"' maxlength='20'><input id='text' type='text' autocomplete='off' placeholder='"+lang["sam"]+"' maxlength='40'><a class='s-btn' onclick='sendMsg()'><span class='icon-send'></span></a></header><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'></div>";
  document.getElementById("content").style.height = "calc(100% - 10rem)";
  document.getElementById("top").style.bottom = "6.3125rem";
  document.getElementById("content").addEventListener("scroll", chkTop);
  document.getElementById("srh").addEventListener("keypress", chkSrh);
  document.getElementById("text").addEventListener("keypress", chkSam);
  db.collection("post").where(firebase.firestore.FieldPath.documentId(), "==", location.pathname.substring(location.pathname.length - 20)).onSnapshot((snapshot) => {
	snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		document.getElementsByTagName("title")[0].innerHTML = tmp_text.innerText.slice(0, 10)+"... - Dizcourze";
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onclick='toPostagain(this)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		document.getElementById("major").append(tmp);
		if (document.getElementById("load") != null) {
		  document.getElementById("load").remove();
		}
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
	if (document.getElementById("load") != null) {
	  document.getElementById("load").remove();
	}
  });
  db.collection("msg").where("post", "==", location.pathname.substring(location.pathname.length - 20)).orderBy("created").onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerHTML = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerHTML = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerHTML = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		if (change.doc.data()["created"] == null) {
		  tmp.innerHTML = "<div id='inpost-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+new Date()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagMsg(this)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div></div>";
		} else {
		  tmp.innerHTML = "<div id='inpost-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='increate-"+change.doc.id+"' class='create'></div><div id='ininv-"+change.doc.id+"' class='ininv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagMsg(this)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div></div>";
		}
		document.getElementById("minor").append(tmp);
	  }
	  if (change.type === "removed") {
	    document.getElementById("inpost-"+change.doc.id).parentNode.remove();
	  }
	});
  });
}
function format(str) {
  str = str.split(" ");
  for (i=0; i<str.length; i+=1) {
    if (str[i].startsWith("@")) {
	  str[i] = "<a class='mention'>"+str[i]+"</a>";
	} else if (str[i].startsWith("#")) {
	  str[i] = "<a href='/search?q="+str[i].substring(1)+"' target='_blank' onclick='stop(event)'>"+str[i]+"</a>";
	} else if (str[i].startsWith("http://") || str[i].startsWith("https://")) {
	  if (str[i].endsWith(".png") || str[i].endsWith(".jpg") || str[i].endsWith(".gif") || str[i].endsWith(".svg")) {
	    str[i] = "<div class='out'><img class='in' src='"+str[i]+"' onerror='chgImg(this)'></div>";
	  } else if (str[i].endsWith(".mp4") || str[i].endsWith(".webm")) {
	    str[i] = "<div class='out'><video class='in' src='"+str[i]+"' onerror='chgVid(this)' controls playsinline></video></div>";
	  } else if (str[i].endsWith(".mp3") || str[i].endsWith(".wav")) {
	    str[i] = "<audio class='aud' src='"+str[i]+"' onerror='chgAud(this)' controls></audio>";
	  } else if (str[i].startsWith("https://youtu.be/")) {
	    str[i] = "<div class='out'><iframe class='in' src='https://www.youtube.com/embed/"+str[i].substring(17)+"' frameborder='0' allowfullscreen></iframe></div>";
	  } else {
	    str[i] = "<a href='"+str[i]+"' target='_blank' onclick='stop(event)'>"+str[i]+"</a>";
	  }
	}
  }
  str = str.join(" ");
  return str;
}
function chgAud(elm) {
  elm.src = "";
}
function chgImg(elm) {
  elm.src = "https://i.imgur.com/3XnNIXY.jpg";
}
function chgVid(elm) {
  elm.src = "https://i.imgur.com/OMhDLGN.mp4";
}
function stop(evt) {
  evt.stopPropagation();
}
function sendMsg() {
  if (document.getElementById("text").value != "") {
    if (document.getElementById("name").value == "") {
	  name = "Anonymous";
	} else {
	  name = document.getElementById("name").value;
	}
	data = {
	  "ava": document.getElementById("ava").value,
	  "name": name,
	  "text": document.getElementById("text").value,
	  "created": firebase.firestore.FieldValue.serverTimestamp(),
	  "post": location.pathname.substring(location.pathname.length - 20)
	};
	db.collection("msg").add(data);
	data = {
	  "msg": Number(document.getElementById("msg-"+location.pathname.substring(location.pathname.length - 20)).dataset.num)+1
	};
	db.collection("post").doc(location.pathname.substring(location.pathname.length - 20)).update(data);
	document.getElementById("ava").value = "";
	document.getElementById("name").value = "";
	document.getElementById("text").value = "";
  }
}
function sendPost() {
  if (document.getElementById("text").value != "") {
    if (document.getElementById("name").value == "") {
	  name = "Anonymous";
	} else {
	  name = document.getElementById("name").value;
	}
	data = {
	  "ava": document.getElementById("ava").value,
	  "name": name,
	  "text": document.getElementById("text").value,
	  "created": firebase.firestore.FieldValue.serverTimestamp(),
	  "tag": chkTag(),
	  "love": 0,
	  "msg": 0
	};
	db.collection("post").add(data);
	document.getElementById("ava").value = "";
	document.getElementById("name").value = "";
	document.getElementById("text").value = "";
  }
}
function chkTag() {
  tagList = [];
  txtList = document.getElementById("text").value.split(" ");
  for (i=0; i<txtList.length; i+=1) {
    if (txtList[i].startsWith("#")) {
	  tagList.push(txtList[i].substring(1));
	}
  }
  return tagList;
}
function share(elm, evt) {
  evt.stopPropagation();
  navigator.clipboard.writeText("https://dizcourze/post/"+elm.id.substring(6));
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='txt'>"+lang["lcc"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function love(elm, evt) {
  evt.stopPropagation();
  data = {
    "love": Number(elm.dataset.num)+1
  };
  db.collection("post").doc(elm.id.substring(5)).update(data);
}
function over(elm) {
  elm.parentNode.style.background = "var(--back-color)";
}
function out(elm) {
  elm.parentNode.style.background = "";
}
function flagPost(elm, evt) {
  evt.stopPropagation();
  data = {
    "created": firebase.firestore.FieldValue.serverTimestamp(),
	"id": elm.id.substring(5),
	"type": "post"
  };
  db.collection("flag").add(data);
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='txt'>"+lang["flag"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function flagMsg(elm) {
  data = {
    "created": firebase.firestore.FieldValue.serverTimestamp(),
	"id": elm.id.substring(5),
	"type": "msg"
  };
  db.collection("flag").add(data);
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='txt'>"+lang["flag"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function setTime() {
  l1 = document.getElementsByClassName("inv");
  if (l1[0] != undefined) {
    for (i=0; i<l1.length; i+=1) {
      d1 = new Date();
	  d2 = new Date(l1[i].innerHTML);
	  if (d1-d2 < 60000) {
		document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = Math.floor((d1-d2)/1000)+lang["s"];
	  } else if (d1-d2 < 3600000) {
	    document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = Math.floor((d1-d2)/60000)+lang["m"];
	  } else if (d1-d2 < 86400000) {
	    document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = Math.floor((d1-d2)/3600000)+lang["h"];
	  } else if (d1.getFullYear() == d2.getFullYear()) {
	    if (getCookie("lang") == "TW" || getCookie("lang") == "JP") {
		  document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = (d2.getMonth()+1)+lang["mon"]+d2.getDate()+lang["date"];
		} else {
		  mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		  document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = mon[d2.getMonth()]+" "+d2.getDate();
		}
	  } else {
	    if (getCookie("lang") == "TW" || getCookie("lang") == "JP") {
		  document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = d2.getFullYear()+lang["year"]+(d2.getMonth()+1)+lang["mon"]+d2.getDate()+lang["date"];
		} else {
		  mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		  document.getElementById("create-"+l1[i].id.substring(4)).innerHTML = mon[d2.getMonth()]+" "+d2.getDate()+", "+d2.getFullYear();
		}
	  }
    }
  }
  l2 = document.getElementsByClassName("ininv");
  if (l2[0] != undefined) {
    for (i=0; i<l2.length; i+=1) {
      d1 = new Date();
	  d2 = new Date(l2[i].innerHTML);
	  if (d1-d2 < 60000) {
		document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = Math.floor((d1-d2)/1000)+lang["s"];
	  } else if (d1-d2 < 3600000) {
	    document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = Math.floor((d1-d2)/60000)+lang["m"];
	  } else if (d1-d2 < 86400000) {
	    document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = Math.floor((d1-d2)/3600000)+lang["h"];
	  } else if (d1.getFullYear() == d2.getFullYear()) {
	    if (getCookie("lang") == "TW" || getCookie("lang") == "JP") {
		  document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = (d2.getMonth()+1)+lang["mon"]+d2.getDate()+lang["date"];
		} else {
		  mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		  document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = mon[d2.getMonth()]+" "+d2.getDate();
		}
	  } else {
	    if (getCookie("lang") == "TW" || getCookie("lang") == "JP") {
		  document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = d2.getFullYear()+lang["year"]+(d2.getMonth()+1)+lang["mon"]+d2.getDate()+lang["date"];
		} else {
		  mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		  document.getElementById("increate-"+l2[i].id.substring(6)).innerHTML = mon[d2.getMonth()]+" "+d2.getDate()+", "+d2.getFullYear();
		}
	  }
    }
  }
}
function reAva(elm) {
  ava = document.createElement("a");
  ava.classList.add("ava");
  ava.innerHTML = "<span class='icon-user'></span>";
  elm.parentNode.replaceChild(ava, elm);
}
function toPost(elm) {
  window.open("/post/"+elm.id.substring(5));
}
function toPostagain(elm) {
  window.open("/post/"+elm.id.substring(4));
}
function chkTop() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
}
function chkTopandSearch() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
  if (Math.ceil(document.getElementById("content").scrollTop) + document.getElementById("content").clientHeight >= document.getElementById("content").scrollHeight) {
    if (document.getElementById("load") == null) {
	  div = document.createElement("div");
	  div.id = "load";
	  div.innerHTML = "<a class='spinner'></a>";
	  document.getElementById("content").append(div);
	  db.collection("post").where("tag", "array-contains", decodeURI(location.href.split("/")[3].substring(9))).orderBy("created", "desc").startAfter(cursor).limit(10).onSnapshot((snapshot) => {
	    snapshot.docChanges().forEach((change) => {
	      if (change.type === "added") {
	        tmp_ava = document.createElement("div");
		    tmp_ava.innerHTML = change.doc.data()["ava"];
		    tmp_name = document.createElement("div");
		    tmp_name.innerHTML = change.doc.data()["name"];
		    tmp_text = document.createElement("div");
		    tmp_text.innerHTML = change.doc.data()["text"];
		    tmp_text = format(tmp_text.innerText);
		    tmp = document.createElement("div");
		    tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		    document.getElementById("content").append(tmp);
		    if (document.getElementById("load") != null) {
		      document.getElementById("load").remove();
		    }
		    cursor = change.doc.data()["created"].toDate();
	      }
	      if (change.type === "modified") {
	        document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		    document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		    document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	      }
	      if (change.type === "removed") {
	        document.getElementById("post-"+change.doc.id).parentNode.remove();
	      }
	    });
	    if (document.getElementById("load") != null) {
	      document.getElementById("load").remove();
	    }
	  });
    }
  }
}
function chkTopandIndex() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
  if (Math.ceil(document.getElementById("content").scrollTop) + document.getElementById("content").clientHeight >= document.getElementById("content").scrollHeight) {
    if (document.getElementById("load") == null) {
	  div = document.createElement("div");
	  div.id = "load";
	  div.innerHTML = "<a class='spinner'></a>";
	  document.getElementById("content").append(div);
	  db.collection("post").orderBy("created", "desc").startAfter(cursor).limit(10).onSnapshot((snapshot) => {
	    snapshot.docChanges().forEach((change) => {
	      if (change.type === "added") {
	        tmp_ava = document.createElement("div");
		    tmp_ava.innerHTML = change.doc.data()["ava"];
		    tmp_name = document.createElement("div");
		    tmp_name.innerHTML = change.doc.data()["name"];
		    tmp_text = document.createElement("div");
		    tmp_text.innerHTML = change.doc.data()["text"];
		    tmp_text = format(tmp_text.innerText);
		    tmp = document.createElement("div");
		    tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='sep'>·</div><div id='create-"+change.doc.id+"' class='create'></div><div id='inv-"+change.doc.id+"' class='inv'>"+change.doc.data()["created"].toDate()+"</div><a id='flag-"+change.doc.id+"' class='s-btn right' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><div id='msg-"+change.doc.id+"' class='m-btn' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["msg"]+"'><span class='icon-msg'></span>"+count(change.doc.data()["msg"])+"</div><div id='love-"+change.doc.id+"' class='m-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)' data-num='"+change.doc.data()["love"]+"'><span class='icon-love'></span>"+count(change.doc.data()["love"])+"</div><div id='share-"+change.doc.id+"' class='m-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></div></div>";
		    document.getElementById("content").append(tmp);
		    if (document.getElementById("load") != null) {
		      document.getElementById("load").remove();
		    }
		    cursor = change.doc.data()["created"].toDate();
	      }
	      if (change.type === "modified") {
	        document.getElementById("msg-"+change.doc.id).dataset.num = change.doc.data()["msg"];
		    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+count(change.doc.data()["msg"]);
		    document.getElementById("love-"+change.doc.id).dataset.num = change.doc.data()["love"];
		    document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+count(change.doc.data()["love"]);
	      }
	      if (change.type === "removed") {
	        document.getElementById("post-"+change.doc.id).parentNode.remove();
	      }
	    });
	    if (document.getElementById("load") != null) {
	      document.getElementById("load").remove();
	    }
	  });
    }
  }
}
function count(num) {
  if (getCookie("lang") == "TW" || getCookie("lang") == "JP") {
    if (num >= 10000) {
	  num = Math.round(num/1000)/10;
	  return num+lang["w"];
	} else {
	  return num;
	}
  } else {
    if (num >= 1000) {
	  num = Math.round(num/100)/10;
	  return num+lang["k"];
	} else {
	  return num;
	}
  }
}
function toTop() {
  document.getElementById("content").scrollTop = 0;
}
function morePage() {
  document.getElementsByTagName("title")[0].innerHTML = "More - Dizcourze";
  document.getElementById("main").innerHTML = "<div id='app'><header><a class='s-btn' href='/' target='_blank'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='s-btn' onclick='srh()'><span class='icon-search'></span></a><a class='s-btn' href='/more' target='_blank'><span class='icon-more'></span></a></header><div id='content'><div class='more'><div class='l-btn' onclick='chkAbout()'>"+lang["about"]+"</div><div class='l-btn' onclick='chgTheme()'>"+lang["theme"]+"</div><div class='l-btn' onclick='chgLang()'>"+lang["lang"]+"</div><div class='l-btn' onclick='chkDonate()'>"+lang["donate"]+"</div></div></div><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'></div>";
  document.getElementById("content").addEventListener("scroll", chkTop);
  document.getElementById("srh").addEventListener("keypress", chkSrh);
}
function chkDonate() {
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='space'></div><div class='l-btn' onclick='copyAddress()'>"+lang["address"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function copyAddress() {
  navigator.clipboard.writeText("0xB280C2181C34B14a0F9CB39cf6C610260A767761");
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='txt'>"+lang["acc"]+"</div></div>";
}
function chgLang() {
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='space'></div><div class='l-btn' onclick='toEn()'>"+lang["en"]+"</div><div class='l-btn' onclick='toTw()'>"+lang["tw"]+"</div><div class='l-btn' onclick='toJp()'>"+lang["jp"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function toEn() {
  setCookie("lang", "EN", 365);
  location.reload();
}
function toTw() {
  setCookie("lang", "TW", 365);
  location.reload();
}
function toJp() {
  setCookie("lang", "JP", 365);
  location.reload();
}
function chgTheme() {
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='space'></div><div class='l-btn' onclick='toLight()'>"+lang["light"]+"</div><div class='l-btn' onclick='toDark()'>"+lang["dark"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function toLight() {
  setCookie("theme", "1", 365);
  location.reload();
}
function toDark() {
  setCookie("theme", "0", 365);
  location.reload();
}
function chkAbout() {
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='space'></div><div class='l-btn' onclick='toGithub()'>"+lang["github"]+"</div><div class='l-btn' onclick='copyEmail()'>"+lang["email"]+"</div></div>";
  document.getElementById("bg").style.display = "block";
}
function toGithub() {
  window.open("https://github.com/dizcourze/dizcourze");
}
function copyEmail() {
  navigator.clipboard.writeText("contact@dizcourze.com");
  document.getElementById("bg").innerHTML = "<div class='box'><a class='s-btn right' onclick='x()'><span class='icon-x'></span></a><div class='txt'>"+lang["acc"]+"</div></div>";
}
function x() {
  document.getElementById("bg").style.display = "none";
}
function srh() {
  if (document.getElementById("srh").value != "") {
    window.open("/search?q="+document.getElementById("srh").value);
	document.getElementById("srh").value = "";
  }
}
function chkSrh() {
  if (event.key === "Enter") {
    srh();
  }
}
function chkSap() {
  if (event.key === "Enter") {
    sendPost();
  }
}
function chkSam() {
  if (event.key === "Enter") {
    sendMsg();
  }
}
firebase.initializeApp({projectId: "wxj0u6"});
var db = firebase.firestore();
var lang;
var cursor;
setInterval(setTime, 1000);
run();