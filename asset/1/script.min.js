function chkMode() {
  if (getCookie("mode") == "" || getCookie("mode") == "1") {
    setCookie("mode", "1", 365);
	style = document.createElement("link");
	style.rel = "stylesheet";
	style.href = "https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css";
	document.head.append(style);
  } else {
    setCookie("mode", "0", 365);
	style = document.createElement("link");
	style.rel = "stylesheet";
	style.href = "https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-dark.min.css";
	document.head.append(style);
	document.getElementsByTagName("link")[1].href = "/asset/1/style-dark.min.css";
  }
}
function chkLang() {
  if (getCookie("lang") == "") {
    setCookie("lang", "EN", 365);
	langEn();
  } else if (getCookie("lang") == "TW") {
    setCookie("lang", "TW", 365);
	langTw();
  } else if (getCookie("lang") == "JP") {
    setCookie("lang", "JP", 365);
	langJp();
  } else if (getCookie("lang") == "KR") {
    setCookie("lang", "KR", 365);
	langKr();
  } else {
    setCookie("lang", "EN", 365);
	langEn();
  }
}
function copy() {
  navigator.clipboard.writeText("0xB280C2181C34B14a0F9CB39cf6C610260A767761");
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><a class='txt'>"+lang["loc"]+"</a>";
  document.getElementById("bg").style.display = "block";
}
function langTw() {
  lang = {"srh":"搜尋","ava":"大頭貼連結","name":"使用者名稱","sap":"傳送貼文","flag":"成功檢舉","share":"已將連結複製到剪貼簿","sam":"傳送訊息","theme":"主題","mode":"模式","lang":"語言","def":"預設","light":"淺色","dark":"深色","en":"English","tw":"繁體中文","jp":"日本語","kr":"한국어","about":"關於我們","how":"如何使用","rule":"社群規則","sup":"支持我們","about-txt":"一個匿名的社群網路。<br>查看<a href='https://github.com/dizcourze/dizcourze'>Github</a>以了解更多資訊！","how-txt":"1. 使用'@'以提及他人。<br>2. 使用'#'以標記貼文。<br>3. 使用'.jpg/.png/.gif'連結以顯示圖片。<br>4. 使用'.mp4/.ogg/.webm'連結以顯示影片。<br>5. 使用'https://youtu.be/...'連結以嵌入Youtube影片。","rule-txt":"1. 合法，僅此而已。","sup-txt":"幫助我們維護我們的服務！<br>通過捐贈至<a class='color' onclick='copy()'>0xB280C2181C34B14a0F9CB39cf6C610260A767761</a>。","loc":"已將地址複製到剪貼簿"};
}
function langJp() {
  lang = {"srh":"検索","ava":"プロフィール画像リンク","name":"ユーザー名","sap":"ポストを送信","flag":"正常に報告されました","share":"リンクをクリップボードにコピーしました","sam":"メッセージを送信","theme":"テーマ","mode":"モード","lang":"言語","def":"デフォルト","light":"ライト","dark":"ダーク","en":"English","tw":"繁體中文","jp":"日本語","kr":"한국어","about":"私たちに関しては","how":"使い方","rule":"コミュニティルール","sup":"私たちを応援してください","about-txt":"匿名のソーシャルネットワーク。<br>詳細については、<a href='https://github.com/dizcourze/dizcourze'>Github</a>をチェックしてください！","how-txt":"1. 他の人に言及するには、'@'を使用します。<br>2. 投稿にタグを付けるには、'#'を使用します。<br>3. 画像を表示するには、'.jpg/.png/.gif'リンクを使用します。<br>4. ビデオを表示するには、'.mp4/.ogg/.webm'リンクを使用します。<br>5. 'https://youtu.be/...'リンクを使用して、Youtubeビデオを埋め込みます。","rule-txt":"1. 法務、それだけです。","sup-txt":"私たちのサービスを維持するのを手伝ってください！<br><a class='color' onclick='copy()'>0xB280C2181C34B14a0F9CB39cf6C610260A767761</a>に寄付することによって。","loc":"クリップボードにコピーされたアドレス"};
}
function langKr() {
  lang = {"srh":"검색","ava":"프로필 사진 링크","name":"아이디","sap":"게시물 보내기","flag":"성공적으로 보고됨","share":"클립보드에 링크 복사","sam":"메시지 보내기","theme":"테마","mode":"모드","lang":"언어","def":"사전 설정","light":"밝은","dark":"어두운","en":"English","tw":"繁體中文","jp":"日本語","kr":"한국어","about":"회사 소개","how":"사용하는 방법","rule":"커뮤니티 규칙","sup":"당신의 도움이 필요합니다","about-txt":"익명의 소셜 네트워크.<br>자세한 내용은 <a href='https://github.com/dizcourze/dizcourze'>Github</a>에서 확인하세요!","how-txt":"1. '@'를 사용하여 다른 사람을 언급하십시오.<br>2. '#'을 사용하여 게시물에 태그를 지정합니다.<br>3. '.jpg/.png/.gif' 링크를 사용하여 이미지를 표시합니다.<br>4. '.mp4/.ogg/.webm' 링크를 사용하여 비디오를 표시합니다.<br>5. 'https://youtu.be/...' 링크를 사용하여 Youtube 동영상을 퍼가세요.","rule-txt":"1. 법적, 그게 다야.","sup-txt":"서비스를 유지하도록 도와주세요!<br><a class='color' onclick='copy()'>0xB280C2181C34B14a0F9CB39cf6C610260A767761</a>에 기부함으로써.","loc":"주소가 클립보드에 복사됨"};
}
function langEn() {
  lang = {"srh":"Search","ava":"Profile picture link","name":"Username","sap":"Send a post","flag":"Successfully flagged","share":"Link copied to clipboard","sam":"Send a message","theme":"Theme","mode":"Mode","lang":"Language","def":"Default","light":"Light","dark":"Dark","en":"English","tw":"繁體中文","jp":"日本語","kr":"한국어","about":"About us","how":"How to use","rule":"Community Rules","sup":"Support us","about-txt":"An anonymous social network.<br>Check out <a href='https://github.com/dizcourze/dizcourze'>Github</a> for more information!","how-txt":"1. Use '@' to mention others.<br>2. Use '#' to tag posts.<br>3. Use '.jpg/.png/.gif' links to display images.<br>4. Use '.mp4/.ogg/.webm' links to display videos.<br>5. Use the 'https://youtu.be/...' link to embed Youtube videos.","rule-txt":"1. Legal, that's all.","sup-txt":"Help us maintain our service!<br>By donating to <a class='color' onclick='copy()'>0xB280C2181C34B14a0F9CB39cf6C610260A767761</a>.","loc":"Address copied to clipboard"};
}
function morePage() {
  document.getElementById("main").innerHTML = "<div id='app'><header class='sticky'><a class='btn' href='/'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='btn' onclick='srh()'><span class='icon-search'></span></a><a class='btn' href='/more'><span class='icon-more'></span></a></header><div id='content'><div class='collapse'><label onclick='chgTheme()'>"+lang["theme"]+"</label><label onclick='chgMode()'>"+lang["mode"]+"</label><label onclick='chgLang()'>"+lang["lang"]+"</label></div><div class='collapse'><input type='checkbox' id='collapse-section1' aria-hidden='true'><label for='collapse-section1' aria-hidden='true'>"+lang["about"]+"</label><div><p>"+lang["about-txt"]+"</p></div><input type='checkbox' id='collapse-section2' aria-hidden='true'><label for='collapse-section2' aria-hidden='true'>"+lang["how"]+"</label><div><p>"+lang["how-txt"]+"</p></div><input type='checkbox' id='collapse-section3' aria-hidden='true'><label for='collapse-section3' aria-hidden='true'>"+lang["rule"]+"</label><div><p>"+lang["rule-txt"]+"</p></div><input type='checkbox' id='collapse-section4' aria-hidden='true'><label for='collapse-section4' aria-hidden='true'>"+lang["sup"]+"</label><div><p>"+lang["sup-txt"]+"</p></div></div></div></div><div id='bg'><div id='box'></div></div>";
  document.getElementById("content").style.height = "calc(100% - 3.6875rem)";
  document.getElementById("srh").addEventListener("keyup", keySrh);
}
function chgTheme() {
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><div class='m-btn' onclick='toDef()'>"+lang["def"]+"</div>";
  document.getElementById("bg").style.display = "block";
}
function chgMode() {
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><div class='m-btn' onclick='toLight()'>"+lang["light"]+"</div><div class='m-btn' onclick='toDark()'>"+lang["dark"]+"</div>";
  document.getElementById("bg").style.display = "block";
}
function chgLang() {
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><div class='m-btn' onclick='toEn()'>"+lang["en"]+"</div><div class='m-btn' onclick='toTw()'>"+lang["tw"]+"</div><div class='m-btn' onclick='toJp()'>"+lang["jp"]+"</div><div class='m-btn' onclick='toKr()'>"+lang["kr"]+"</div>";
  document.getElementById("bg").style.display = "block";
}
function toDef() {
  setCookie("theme", "1", 365);
  location.reload();
}
function toLight() {
  setCookie("mode", "1", 365);
  location.reload();
}
function toDark() {
  setCookie("mode", "0", 365);
  location.reload();
}
function toEn() {
  setCookie("lang", "EN", 365);
  location.reload();
}
function toTw() {
  setCookie("lang", "TW", 365);
  location.reload();
}
function toJp() {
  setCookie("lang", "JP", 365);
  location.reload();
}
function toKr() {
  setCookie("lang", "KR", 365);
  location.reload();
}
function indexPage() {
  document.getElementById("main").innerHTML = "<div id='app'><header class='sticky'><a class='btn' href='/'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='btn' onclick='srh()'><span class='icon-search'></span></a><a class='btn' href='/more'><span class='icon-more'></span></a></header><div id='content'><div id='new'></div><div id='load'><div id='ctr'><div class='lds-spinner'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div><header class='bot'><input id='ava' type='text' autocomplete='off' placeholder='"+lang["ava"]+"' maxlength='40'><input id='name' type='text' autocomplete='off' placeholder='"+lang["name"]+"' maxlength='20'><input id='text' type='text' autocomplete='off' placeholder='"+lang["sap"]+"' maxlength='80'><a class='btn' onclick='sendPost()'><span class='icon-send'></span></a></header><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'><div id='box'></div></div>";
  document.getElementById("content").style.height = "calc(100% - 10rem)";
  document.getElementById("top").style.marginBottom = "6.3125rem";
  document.getElementById("content").addEventListener("scroll", chkScroll);
  document.getElementById("srh").addEventListener("keyup", keySrh);
  document.getElementById("text").addEventListener("keyup", keySap);
  db.collection("post").orderBy("created", "desc").startAfter(new Date()).limit(10).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		document.getElementById("load").append(tmp);
		cursor = change.doc.data()["created"].toDate();
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  db.collection("post").orderBy("created").startAfter(new Date()).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		document.getElementById("new").prepend(tmp);
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  document.getElementById("ctr").remove();
}
function postPage() {
  document.getElementById("main").innerHTML = "<div id='app'><header class='sticky'><a class='btn' href='/'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='btn' onclick='srh()'><span class='icon-search'></span></a><a class='btn' href='/more'><span class='icon-more'></span></a></header><div id='content'><div id='origin'><div id='ctr'><div class='lds-spinner'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div id='load'></div></div><header class='bot'><input id='ava' type='text' autocomplete='off' placeholder='"+lang["ava"]+"' maxlength='40'><input id='name' type='text' autocomplete='off' placeholder='"+lang["name"]+"' maxlength='20'><input id='text' type='text' autocomplete='off' placeholder='"+lang["sam"]+"' maxlength='40'><a class='btn' onclick='sendMsg()'><span class='icon-send'></span></a></header><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'><div id='box'></div></div>";
  document.getElementById("content").style.height = "calc(100% - 10rem)";
  document.getElementById("top").style.marginBottom = "6.3125rem";
  document.getElementById("content").addEventListener("scroll", chkScrollforPost);
  document.getElementById("srh").addEventListener("keyup", keySrh);
  document.getElementById("text").addEventListener("keyup", keySam);
  db.collection("post").where(firebase.firestore.FieldPath.documentId(), "==", location.pathname.substring(location.pathname.length - 20)).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onclick='thisPost(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)'><span class='icon-share'></span></a></div>";
		document.getElementById("origin").append(tmp);
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  db.collection("msg").where("post", "==", location.pathname.substring(location.pathname.length - 20)).orderBy("created").limit(10).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='msg-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagMsg(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div></div>";
		document.getElementById("load").append(tmp);
		cursor = change.doc.data()["created"].toDate();
	  }
	  if (change.type === "removed") {
	    document.getElementById("msg-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  document.getElementById("ctr").remove();
}
function sendMsg() {
  if (document.getElementById("text").value != "") {
    if (document.getElementById("name").value == "") {
	  name = "Anonymous";
	} else {
	  name = document.getElementById("name").value;
	}
	data = {
	  "ava": document.getElementById("ava").value,
	  "name": name,
	  "text": document.getElementById("text").value,
	  "created": firebase.firestore.Timestamp.fromDate(new Date()),
	  "post": location.pathname.substring(location.pathname.length - 20)
	};
	db.collection("msg").add(data);
	data = {
	  "msg": Number(document.getElementById("msg-"+location.pathname.substring(location.pathname.length - 20)).innerText)+1
	};
	db.collection("post").doc(location.pathname.substring(location.pathname.length - 20)).update(data);
	document.getElementById("ava").value = "";
	document.getElementById("name").value = "";
	document.getElementById("text").value = "";
  }
}
function searchPage() {
  document.getElementById("main").innerHTML = "<div id='app'><header class='sticky'><a class='btn' href='/'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='btn' onclick='srh()'><span class='icon-search'></span></a><a class='btn' href='/more'><span class='icon-more'></span></a></header><div id='content'><div id='new'></div><div id='load'><div id='ctr'><div class='lds-spinner'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div><div id='top' onclick='toTop()'><span class='icon-top'></span></div></div><div id='bg'><div id='box'></div></div>";
  document.getElementById("content").style.height = "calc(100% - 3.6875rem)";
  document.getElementById("content").addEventListener("scroll", chkScrollforSearch);
  document.getElementById("srh").addEventListener("keyup", keySrh);
  db.collection("post").where("tag", "array-contains", location.search.substring(3)).orderBy("created", "desc").startAfter(new Date()).limit(10).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		document.getElementById("load").append(tmp);
		cursor = change.doc.data()["created"].toDate();
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  db.collection("post").where("tag", "array-contains", location.search.substring(3)).orderBy("created").startAfter(new Date()).onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
	  if (change.type === "added") {
	    tmp_ava = document.createElement("div");
		tmp_ava.innerText = change.doc.data()["ava"];
		tmp_name = document.createElement("div");
		tmp_name.innerText = change.doc.data()["name"];
		tmp_text = document.createElement("div");
		tmp_text.innerText = change.doc.data()["text"];
		tmp_text = format(tmp_text.innerText);
		tmp = document.createElement("div");
		tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		document.getElementById("new").prepend(tmp);
	  }
	  if (change.type === "modified") {
	    document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	  }
	  if (change.type === "removed") {
	    document.getElementById("post-"+change.doc.id).parentNode.remove();
	  }
	});
  });
  document.getElementById("ctr").remove();
}
function love(elm, evt) {
  evt.stopPropagation();
  data = {
    "love": Number(elm.innerText)+1
  };
  db.collection("post").doc(elm.id.substring(5)).update(data);
}
function share(elm, evt) {
  evt.stopPropagation();
  navigator.clipboard.writeText("https://dizcourze/post/"+elm.id.substring(6));
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><a class='txt'>"+lang["share"]+"</a>";
  document.getElementById("bg").style.display = "block";
}
function over(elm) {
  elm.parentNode.style.background = "var(--back-color)";
}
function out(elm) {
  elm.parentNode.style.background = "";
}
function toPost(elm) {
  location.href = "/post/"+elm.id.substring(5);
}
function thisPost(elm) {
  location.href = "/post/"+elm.id.substring(4);
}
function flagPost(elm, evt) {
  evt.stopPropagation();
  data = {
    "created": firebase.firestore.Timestamp.fromDate(new Date()),
	"id": elm.id.substring(5),
	"type": "post"
  };
  db.collection("flag").add(data);
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><a class='txt'>"+lang["flag"]+"</a>";
  document.getElementById("bg").style.display = "block";
}
function flagMsg(elm) {
  data = {
    "created": firebase.firestore.Timestamp.fromDate(new Date()),
	"id": elm.id.substring(5),
	"type": "msg"
  };
  db.collection("flag").add(data);
  document.getElementById("box").innerHTML = "<a class='btn rtf' onclick='x()'><span class='icon-x'></span></a><a class='txt'>"+lang["flag"]+"</a>";
  document.getElementById("bg").style.display = "block";
}
function x() {
  document.getElementById("bg").style.display = "none";
}
function reAva(elm) {
  ava = document.createElement("a");
  ava.classList.add("ava");
  ava.innerHTML = "<span class='icon-user'></span>";
  elm.parentNode.replaceChild(ava, elm);
}
function format(str) {
  str = str.split(" ");
  for (i=0; i<str.length; i+=1) {
    if (str[i].startsWith("@")) {
	  str[i] = "<a class='mention'>"+str[i]+"</a>";
	} else if (str[i].startsWith("#")) {
	  str[i] = "<a href='/search?q="+str[i].substring(1)+"'>"+str[i]+"</a>";
	} else if (str[i].startsWith("http://") || str[i].startsWith("https://")) {
	  if (str[i].endsWith(".png") || str[i].endsWith(".jpg") || str[i].endsWith(".gif")) {
	    str[i] = "<div class='out'><img class='in' src='"+str[i]+"' onerror='chgImg(this)'></div>";
	  } else if (str[i].endsWith(".mp4") || str[i].endsWith(".ogg") || str[i].endsWith(".webm")) {
	    str[i] = "<div class='out'><video class='in' src='"+str[i]+"' onerror='chgVid(this)' controls playsinline></video></div>";
	  } else if (str[i].startsWith("https://youtu.be/")) {
	    str[i] = "<div class='out'><iframe class='in' src='https://www.youtube.com/embed/"+str[i].substring(17)+"' frameborder='0' allowfullscreen></iframe></div>";
	  } else {
	    str[i] = "<a href='"+str[i]+"'>"+str[i]+"</a>";
	  }
	}
  }
  str = str.join(" ");
  return str;
}
function chgImg(elm) {
  elm.src = "https://i.imgur.com/3XnNIXY.jpg";
}
function chgVid(elm) {
  elm.src = "https://i.imgur.com/OMhDLGN.mp4";
}
function toTop() {
  document.getElementById("content").scrollTop = 0;
}
function chkScroll() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
  if (Math.round(document.getElementById("content").scrollTop) + document.getElementById("content").clientHeight === document.getElementById("content").scrollHeight) {
    db.collection("post").orderBy("created", "desc").startAfter(cursor).limit(10).onSnapshot((snapshot) => {
	  snapshot.docChanges().forEach((change) => {
	    if (change.type === "added") {
	      tmp_ava = document.createElement("div");
		  tmp_ava.innerText = change.doc.data()["ava"];
		  tmp_name = document.createElement("div");
		  tmp_name.innerText = change.doc.data()["name"];
		  tmp_text = document.createElement("div");
		  tmp_text.innerText = change.doc.data()["text"];
		  tmp_text = format(tmp_text.innerText);
		  tmp = document.createElement("div");
		  tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		  document.getElementById("load").append(tmp);
		  cursor = change.doc.data()["created"].toDate();
	    }
	    if (change.type === "modified") {
	      document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		  document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	    }
	    if (change.type === "removed") {
	      document.getElementById("post-"+change.doc.id).parentNode.remove();
	    }
	  });
	});
  }
}
function chkScrollforPost() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
  if (Math.round(document.getElementById("content").scrollTop) + document.getElementById("content").clientHeight === document.getElementById("content").scrollHeight) {
    db.collection("msg").where("post", "==", location.pathname.substring(location.pathname.length - 20)).orderBy("created").startAfter(cursor).limit(10).onSnapshot((snapshot) => {
	  snapshot.docChanges().forEach((change) => {
	    if (change.type === "added") {
	      tmp_ava = document.createElement("div");
		  tmp_ava.innerText = change.doc.data()["ava"];
		  tmp_name = document.createElement("div");
		  tmp_name.innerText = change.doc.data()["name"];
		  tmp_text = document.createElement("div");
		  tmp_text.innerText = change.doc.data()["text"];
		  tmp_text = format(tmp_text.innerText);
		  tmp = document.createElement("div");
		  tmp.innerHTML = "<div id='msg-"+change.doc.id+"' class='in-post'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagMsg(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div></div>";
		  document.getElementById("load").append(tmp);
		  cursor = change.doc.data()["created"].toDate();
	    }
	    if (change.type === "removed") {
	      document.getElementById("msg-"+change.doc.id).parentNode.remove();
	    }
	  });
	});
  }
}
function chkScrollforSearch() {
  if (document.getElementById("content").scrollTop >= 100) {
    document.getElementById("top").style.display = "block";
  } else {
    document.getElementById("top").style.display = "none";
  }
  if (Math.round(document.getElementById("content").scrollTop) + document.getElementById("content").clientHeight === document.getElementById("content").scrollHeight) {
    db.collection("post").where("tag", "array-contains", location.search.substring(3)).orderBy("created", "desc").startAfter(cursor).limit(10).onSnapshot((snapshot) => {
	  snapshot.docChanges().forEach((change) => {
	    if (change.type === "added") {
	      tmp_ava = document.createElement("div");
		  tmp_ava.innerText = change.doc.data()["ava"];
		  tmp_name = document.createElement("div");
		  tmp_name.innerText = change.doc.data()["name"];
		  tmp_text = document.createElement("div");
		  tmp_text.innerText = change.doc.data()["text"];
		  tmp_text = format(tmp_text.innerText);
		  tmp = document.createElement("div");
		  tmp.innerHTML = "<div id='post-"+change.doc.id+"' class='post' onclick='toPost(this)'><img class='ava' src='"+tmp_ava.innerText+"' onerror='reAva(this)'><div class='name'>"+tmp_name.innerText+"</div><div class='create'>"+change.doc.data()["created"].toDate().toLocaleString("ja-jp")+"</div><a id='flag-"+change.doc.id+"' class='btn rtf' onclick='flagPost(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-flag'></span></a><div class='text'>"+tmp_text+"</div><a id='msg-"+change.doc.id+"' class='s-btn' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-msg'></span>"+change.doc.data()["msg"]+"</a><a id='love-"+change.doc.id+"' class='s-btn' onclick='love(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-love'></span>"+change.doc.data()["love"]+"</a><a id='share-"+change.doc.id+"' class='s-btn' onclick='share(this, event)' onmouseover='over(this)' onmouseout='out(this)'><span class='icon-share'></span></a></div>";
		  document.getElementById("load").append(tmp);
		  cursor = change.doc.data()["created"].toDate();
	    }
	    if (change.type === "modified") {
	      document.getElementById("msg-"+change.doc.id).innerHTML = "<span class='icon-msg'></span>"+change.doc.data()["msg"];
		  document.getElementById("love-"+change.doc.id).innerHTML = "<span class='icon-love'></span>"+change.doc.data()["love"];
	    }
	    if (change.type === "removed") {
	      document.getElementById("post-"+change.doc.id).parentNode.remove();
	    }
	  });
	});
  }
}
function sendPost() {
  if (document.getElementById("text").value != "") {
    if (document.getElementById("name").value == "") {
	  name = "Anonymous";
	} else {
	  name = document.getElementById("name").value;
	}
	data = {
	  "ava": document.getElementById("ava").value,
	  "name": name,
	  "text": document.getElementById("text").value,
	  "created": firebase.firestore.Timestamp.fromDate(new Date()),
	  "tag": chkTag(),
	  "love": 0,
	  "msg": 0
	};
	db.collection("post").add(data);
	document.getElementById("ava").value = "";
	document.getElementById("name").value = "";
	document.getElementById("text").value = "";
  }
}
function chkTag() {
  tagList = [];
  txtList = document.getElementById("text").value.split(" ");
  for (i=0; i<txtList.length; i+=1) {
    if (txtList[i].startsWith("#")) {
	  tagList.push(txtList[i].substring(1));
	}
  }
  return tagList;
}
function keySap(event) {
  if (event.keyCode === 13) {
    sendPost();
  }
}
function keySam(event) {
  if (event.keyCode === 13) {
    sendMsg();
  }
}
function errPage() {
  document.getElementById("main").innerHTML = "<div id='app'><header class='sticky'><a class='btn' href='/'><span class='icon-logo'></span></a><input id='srh' type='text' autocomplete='off' placeholder='"+lang["srh"]+"'><a class='btn' onclick='srh()'><span class='icon-search'></span></a><a class='btn' href='/more'><span class='icon-more'></span></a></header><div id='content'><div id='ctr'><div class='lds-spinner'><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div>";
  document.getElementById("content").style.height = "calc(100% - 3.6875rem)";
  document.getElementById("srh").addEventListener("keyup", keySrh);
}
function keySrh(event) {
  if (event.keyCode === 13) {
    srh();
  }
}
function srh() {
  if (document.getElementById("srh").value != "") {
    location.href = "/search?q="+document.getElementById("srh").value;
  }
}
function chkPath() {
  if (location.pathname == "/") {
    indexPage();
  } else if (location.pathname == "/more") {
    morePage();
  } else if (location.pathname.startsWith("/search")) {
    searchPage();
  } else if (location.pathname.startsWith("/post/")) {
    postPage();
  } else {
    errPage();
  }
}
function go() {
  chkMode();
  chkLang();
  chkPath();
}
var db = firebase.firestore();
var lang;
var cursor;
go();
